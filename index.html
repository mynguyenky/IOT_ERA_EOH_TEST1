<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>3-Gang Switch IFrame</title>
<style>
  :root{
    --bg:#f5f7fb; --plate:#ffffff; --stroke:#d5d9e2;
    --text:#0f172a; --muted:#64748b;
    --on:#22c55e; --off:#94a3b8;
    --ind-on:#3b82f6; --ind-off:#cbd5e1;
  }
  html,body{height:100%;margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;}
  .wrap{height:100%;display:grid;place-items:center;padding:8px;}
  .panel{
    width:min(92vw,420px); aspect-ratio:1/1; background:var(--plate);
    border-radius:14px; box-shadow:0 6px 22px rgba(2,6,23,.12);
    display:grid; grid-template-columns:repeat(3,1fr); overflow:hidden;
    border:1px solid var(--stroke);
  }
  .key{
    position:relative; display:grid; grid-template-rows:1fr auto 16px; align-items:end;
    border-left:1px solid var(--stroke);
    cursor:pointer; /* Thêm con trỏ chuột cho toàn bộ khu vực */
  }
  /* ✅ SỬA LỖI: Ngăn các phần tử con nhận sự kiện click */
  .key > * {
    pointer-events: none;
  }
  .key:first-child{border-left:none;}
  .btn{
    margin:14px; border-radius:10px; border:1px solid var(--stroke);
    background:linear-gradient(#ffffff,#f3f6fb);
    box-shadow: inset 0 1px 0 #fff, 0 2px 6px rgba(15,23,42,.08);
    outline:none; transition:transform .05s ease;
  }
  .key:active .btn{transform:translateY(1px);} /* Thay đổi :active từ .btn sang .key */
  .label{
    text-align:center; font-size:14px; color:var(--muted); margin-bottom:8px;
    letter-spacing:.3px; user-select:none;
  }
  .dot{
    height:4px; width:24px; border-radius:999px; margin:0 auto 12px;
    background:var(--ind-off); transition:background-color .18s ease;
  }
  /* ON state visuals */
  .key.on .btn{background:linear-gradient(#eafff3,#d9ffe7); border-color:#b7efc5;}
  .key.on .label{color:var(--on); font-weight:600;}
  .key.on .dot{background:var(--ind-on);}
  /* Accessibility */
  .key:focus-visible{
      outline: 2px solid rgba(59,130,246,.5);
      outline-offset: -3px;
      border-radius: 10px;
  }
  /* Tiny header for device info */
  .head{
    position:absolute; top:8px; right:12px; color:#94a3b8; font-size:11px; letter-spacing:.2px;
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="panel" id="panel">
    <div class="head">
      <span id="deviceId">device-unknown</span>
    </div>

    <div class="key" id="sw1" tabindex="0" role="switch" aria-label="Công tắc 1" aria-checked="false">
      <button class="btn" id="btn-sw1" aria-hidden="true"></button>
      <div class="label"><span id="status-sw1">OFF</span></div>
      <div class="dot" id="dot-sw1"></div>
    </div>

    <div class="key" id="sw2" tabindex="0" role="switch" aria-label="Công tắc 2" aria-checked="false">
      <button class="btn" id="btn-sw2" aria-hidden="true"></button>
      <div class="label"><span id="status-sw2">OFF</span></div>
      <div class="dot" id="dot-sw2"></div>
    </div>

    <div class="key" id="sw3" tabindex="0" role="switch" aria-label="Công tắc 3" aria-checked="false">
      <button class="btn" id="btn-sw3" aria-hidden="true"></button>
      <div class="label"><span id="status-sw3">OFF</span></div>
      <div class="dot" id="dot-sw3"></div>
    </div>
  </div>
</div>

<script>
  // ---- Local state ----
  const state = { sw1:false, sw2:false, sw3:false };
  const ids = ["sw1","sw2","sw3"];

  function render(id){
    const on = !!state[id];
    const key = document.getElementById(id);
    const status = document.getElementById(`status-${id}`);
    key.classList.toggle('on', on);
    status.textContent = on ? "ON" : "OFF";
    key.setAttribute('aria-checked', String(on)); // Cập nhật thuộc tính hỗ trợ tiếp cận
  }

  function toggle(id){
    state[id] = !state[id];
    render(id);
    // ---- ERA: send command up to parent iframe ----
    window.parent?.postMessage({type:"era:command", id, value:state[id]}, "*");
  }

  // Init keys
  ids.forEach(id=>{
    const keyElement = document.getElementById(id);

    // Gán sự kiện click cho toàn bộ thẻ div ".key"
    keyElement.addEventListener('click', ()=>toggle(id));

    // Keyboard toggle with Enter/Space
    keyElement.addEventListener('keydown', (e)=>{
      if(e.code==="Space"||e.code==="Enter"){ e.preventDefault(); toggle(id); }
    });
    render(id);
  });

  // ---- ERA: receive updates from parent ----
  window.addEventListener("message", (event)=>{
    const msg = event.data || {};
    if(msg.type === "era:update" && ids.includes(msg.id)){
      state[msg.id] = !!msg.value; render(msg.id);
    }
    if(msg.type === "era:batch" && msg.data){
      ids.forEach(k=>{ if(k in msg.data) { state[k]=!!msg.data[k]; render(k); } });
      if(msg.deviceId){ document.getElementById("deviceId").textContent = msg.deviceId; }
    }
    if(msg.type === "era:device" && msg.deviceId){
      document.getElementById("deviceId").textContent = msg.deviceId;
    }
  });

  // ---- Optional: announce ready to ERA ----
  window.parent?.postMessage({type:"era:ready", widget:"switch-3gang"}, "*");
</script>
</body>
</html>